generator client {
  provider   = "prisma-client-js"
  output     = "../src/generated/prisma"
  engineType = "client"
  runtime    = "bun"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  OWNER   // Full access + Billing
  ADMIN   // Management access
  EDITOR  // Can create/edit ads
  VIEWER  // Read-only access
}

enum AdStatus {
  PENDING     // Job created in DB, not yet in Queue
  PROCESSING  // Worker has picked up the job
  COMPLETED   // AI generation and upload successful
  FAILED      // Job terminated due to error
}

enum AdType {
  IMAGE
  VIDEO
}

enum TransactionType {
  GENERATION 
  REFUND    
  TOPUP      
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  firstName    String?
  lastName     String?
  isVerified   Boolean @default(false)

  tokenVersion Int @default(0)

  members  Member[]   
  sessions Sessions[] 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Tenant {
  id           String @id @default(uuid())
  name         String
  tokenBalance Int    @default(0) 

  members      Member[]
  ads          Ad[]
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Member {
  id       String @id @default(uuid())
  role     Role   @default(VIEWER)
  userId   String
  tenantId String

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, tenantId])
  @@index([tenantId]) 
}

model Sessions {
  id           String @id @default(uuid())
  refreshToken String @unique 
  userId       String
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress String?
  userAgent String?

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model Ad {
  id             String  @id @default(uuid())
  tenantId       String
  userId         String 
  type           AdType  @default(IMAGE)
  prompt         String
  refinedPrompt String
  negativePrompt String? // Things the AI should avoid (e.g. "blurry")

  // Storage paths
  contentUrl   String?   

  status       AdStatus @default(PENDING)
  errorMessage String?  @unique // Logs the specific failure reason

  /// Stores technical AI params (model version, seed, steps, etc.)
  config        Json? 
  
  /// The ID returned by the external AI provider (OpenAI/Replicate)
  externalJobId String? @unique 

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId]) 
}

model Transaction {
  id        String @id @default(uuid())
  tenantId  String
  amount    Int    // Negative for spending, positive for adding
  type      TransactionType 
  adId      String? @unique // Links to the Ad that caused this spend
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
}